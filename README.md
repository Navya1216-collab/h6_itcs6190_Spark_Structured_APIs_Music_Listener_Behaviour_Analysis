# Music Listener Behaviour Analysis Using Spark Structured APIs

## **Overview**

This assignment involves using Spark Structured APIs to analyze user listening behaviour and music patterns from a fictional streaming platform. The objective is to identify genre popularity, loyal listeners, night owl users, and top listeners by processing synthetic datasets generated for this project.

-----

## **Prerequisites**

Before starting, ensure you have the following software installed:

* **Python 3.x**: This project requires Python 3.x.  
* **PySpark**: Install PySpark using pip.  
* **Apache Spark**: Ensure Spark is installed and configured.  

The full list of requirements can be found in the `requirements.txt` file.

-----

## **Dataset Description**

You will work with one CSV file generated by the `generate_data.py` script:

* **`music_listeners.csv`**
  * `user_id`: Unique ID of the user  
  * `genre`: Genre of the song played (e.g., Pop, Rock, Jazz)  
  * `timestamp`: Date and time the song was played  
  * `play_count`: Number of times the user played a song in that session  
  * `loyalty_score`: Score representing how loyal a user is to their favorite genre  

-----

## **Repository Structure**

The repository should have the following structure:

```
.
├── generate_data.py
├── analysis.py
├── requirements.txt
├── output/
└── README.md
```

-----

## **Output Directory Structure**

The results of each analysis task are saved to individual files within a structured directory:

```
output/
├── loyal_users/
├── night_owls/
├── genre_popularity/
└── top_users/
```

-----

## **Tasks and Outputs**

You are required to complete the following four analysis tasks using Spark Structured APIs, with each result saved to an individual CSV file:

1. **Identify loyal users**: Users with `loyalty_score > 0.8`.  
   * **Output Path**: `output/loyal_users/`

2. **Identify night owl users**: Users who listen to music between **12 AM and 5 AM**.  
   * **Output Path**: `output/night_owls/`

3. **Analyze genre popularity**: Count total plays per genre across all users.  
   * **Output Path**: `output/genre_popularity/`

4. **Find top listeners**: Users ranked by total play counts.  
   * **Output Path**: `output/top_users/`

-----

## **Execution Instructions**

### **1. Generate the Input Data**
Run the `generate_data.py` script to create the `music_listeners.csv` file:
```bash
python3 generate_data.py
```

### **2. Run the Analysis**
Execute the `analysis.py` script to perform all analysis tasks and generate the output files:
```bash
python3 analysis.py
```

### **3. Verify the Outputs**
Check the `output/` directory to find the resulting CSV files:
```bash
ls output/
```

-----

## **Errors and Resolutions**

During development and testing, the following issues were identified and fixed:

1. **Empty Output Files**  
   *Cause*: Filter logic was incorrect (e.g., loyalty score comparison was not applied correctly).  
   *Resolution*: Fixed the filter condition and ensured `.write.mode("overwrite").csv(...)` was used to save outputs.

2. **SyntaxError: Unterminated String Literal**  
   *Cause*: Missing closing parenthesis in the filter expression.  
   *Resolution*: Corrected filter syntax in `analysis.py`.  

3. **NameError: `cat` not defined**  
   *Cause*: Accidentally copied a shell command (`cat > analysis.py`) into the Python file.  
   *Resolution*: Removed invalid lines; only valid Python code kept in `analysis.py`.

4. **No Results for Loyalty Score > 0.8**  
   *Cause*: Dataset distribution issue or filter threshold too strict.  
   *Resolution*: Verified generator script, confirmed data had scores > 0.8, and corrected filtering logic.

5. **Git Error: Pathspec did not match any files**  
   *Cause*: Attempted to commit a file not inside the repo.  
   *Resolution*: Copied files into repo root before staging and committing.

